# 铁路 12306 复刻项目 — 需求场景与需求树

- 版本：v1.0
- 日期：2025-11-15

## 1. 业务场景总览

- S1 用户注册与登录
- S2 常用乘车人管理（查看/新增/删除）
- S3 车票查询（单程）
- S4 车次筛选（类型/席别）与条件修改
- S5 订单创建（预订/提交）
- S6 订单支付（模拟）与订单列表查看
- S7 个人信息查看与联系方式编辑

## 2. 场景详述

### S1 用户注册与登录

- 参与者：未注册用户、已注册用户
- 前置条件：用户名 `new user` 未被注册；系统可用
- 主成功场景：
  1. 用户在首页点击“注册”进入注册页
  2. 输入：用户名 `new user`、密码与确认 `mypassword`、姓名 `New User`、证件号 `100111222233334443`、手机号 `13812341234`
  3. 勾选协议并提交，提示“注册成功”，跳转首页
  4. 用户点击“登录”，选择“账号登录”
  5. 输入用户名 `new user` 与密码 `mypassword`，点击“立即登录”
  6. 登录成功，首页顶部显示“您好, New User”
- 备选/异常流：
  - 用户名已存在 → 阻止注册并提示
  - 密码不符合策略/不一致 → 阻止注册并提示
  - 登录凭证错误 → 提示“用户名或密码错误”
- 后置条件：账户已创建；默认乘客已关联；会话有效
- 验收点：完成注册与登录，页面显示问候语

### S2 常用乘车人管理

- 参与者：已登录用户
- 前置条件：用户已登录
- 主成功场景（查看/新增/删除）：
  1. 进入“个人中心” → “常用信息管理/乘车人”，列表显示默认乘客
  2. 点击“添加”弹窗，新增乘客“张三”，身份证 `100111222233334444`，手机号 `13812341235`，优惠类型“成人”，保存后出现在列表
  3. 再次“添加”，新增乘客“李四”，身份证 `100111222233334445`，手机号 `13812341236`，优惠类型“成人”，保存后出现在列表
  4. 在列表对“张三”点击“删除”，确认后移除
- 备选/异常流：
  - 证件号重复 → 阻止保存并提示
  - 手机号/证件号格式错误 → 阻止保存并提示
  - 删除受限（存在未出行订单）→ 阻止删除并提示（可选约束）
- 后置条件：列表包含默认乘客与“李四”；“张三”已删除
- 验收点：列表正确增删与展示

### S3 车票查询（单程）

- 参与者：已登录用户
- 前置条件：数据库已预置 2025-12-15/16 的车次数据；城市-车站映射有效
- 主成功场景：
  1. 首页选择“单程”
  2. 输入出发地“北京”、到达地“上海”、出发日期“2025-12-15”
  3. 点击“查询”，跳转“车次列表”并展示符合条件车次
- 备选/异常流：
  - 日期非法/无车次 → 友好提示与空结果展示
- 后置条件：列表页按条件加载
- 验收点：北京→上海的结果展示（含 G/D/K 的相关车次）

### S4 车次筛选与条件修改

- 参与者：已登录用户
- 前置条件：已在车次列表页
- 主成功场景：
  1. 在“车次类型”仅勾选“D-动车”，列表刷新仅显示 D 开头车次
  2. 在“车次席别”仅勾选“一等座”，列表刷新仅显示包含一等座的车次
  3. 修改查询条件为出发地“南京”、目的地“上海”，点击“查询”，页面刷新为南京→上海的车次
- 备选/异常流：
  - 无匹配车次 → 空状态与提示
- 后置条件：筛选与条件修改即时生效
- 验收点：筛选与查询结果一致性

### S5 订单创建（预订与提交）

- 参与者：已登录用户
- 前置条件：车次列表已加载；乘客存在
- 主成功场景：
  1. 在列表页选择第一个车次，点击“预订”，跳转订单填写页，展示列车与乘客信息
  2. 在乘客信息勾选“New User”，为其选择席别“二等座”
  3. 点击“提交订单”，系统创建订单并跳转订单详情，状态为“待支付”
- 备选/异常流：
  - 席别不支持/参数缺失 → 阻止提交并提示
  - 重复提交（短时间同车次同乘客）→ 幂等返回同一订单（建议）
- 后置条件：产生“待支付”订单
- 验收点：订单详情展示与状态“待支付”

### S6 订单支付（模拟）与订单列表

- 参与者：已登录用户
- 前置条件：存在“待支付”订单
- 主成功场景：
  1. 进入“订单中心/火车票订单/未完成订单”，看到待支付列表
  2. 点击第一个订单“去支付”，弹出模拟支付成功提示
  3. 确认并返回列表，订单状态更新为“已支付”
  4. 切换至“未出行订单”，可见已支付订单
- 备选/异常流：
  - 非待支付订单发起支付 → 阻止并提示
  - 重复支付 → 保持幂等返回已支付状态
- 后置条件：订单状态流转为“已支付”
- 验收点：列表状态一致性与支付提示流程

### S7 个人信息查看与联系方式编辑

- 参与者：已登录用户
- 前置条件：用户资料存在
- 主成功场景：
  1. 进入“个人中心/个人信息/查看个人信息”，显示基本信息与联系方式
  2. 在“联系方式”模块点击“编辑”，字段变为可输入
  3. 输入邮箱 `newuser@example.com`，点击“保存”
  4. 提示“修改成功”，页面显示更新后的邮箱
- 备选/异常流：
  - 邮箱格式非法 → 阻止保存并提示
- 后置条件：联系方式更新
- 验收点：信息展示与保存反馈

## 3. 需求树

### 3.1 功能需求树（F）

- F 用户功能总览
  - F1 用户认证
    - F1.1 注册（表单校验、协议勾选、默认乘客创建）
    - F1.2 登录（账号密码、成功问候语展示、会话）
  - F2 常用乘车人
    - F2.1 查看（列表展示）
    - F2.2 添加（姓名/证件/手机号/优惠类型校验与保存）
    - F2.3 删除（确认框、受限删除策略）
  - F3 车票查询与筛选
    - F3.1 单程查询（城市、日期）
    - F3.2 按车次类型筛选（G/D/K）
    - F3.3 按席别筛选（商务/一等/二等/硬座/硬卧/软卧）
    - F3.4 修改查询条件（并刷新列表）
  - F4 订单
    - F4.1 选择车次并预订（跳转订单页）
    - F4.2 提交订单（乘客勾选、席别选择、待支付）
    - F4.3 支付订单（模拟支付、状态更新）
    - F4.4 订单列表（未完成/未出行）
  - F5 个人信息
    - F5.1 查看个人信息（基本信息与联系方式）
    - F5.2 编辑联系方式（邮箱编辑与保存）
  - F6 初始化与数据
    - F6.1 用户状态清理（`new user`）
    - F6.2 车次数据预置（2025-12-15/16 全量）

### 3.2 非功能需求树（N）

- N 非功能总览
  - N1 安全
    - N1.1 密码散列存储（bcrypt/argon2）
    - N1.2 会话安全（HttpOnly/Secure、CSRF、XSS 防护）
    - N1.3 访问控制（未登录限制）
    - N1.4 操作日志（注册/登录/乘客增删/订单创建与支付）
  - N2 性能
    - N2.1 查询响应 ≤ 2s
    - N2.2 列表/筛选 UI 反馈 ≤ 1s
  - N3 可靠性
    - N3.1 订单事务保障
    - N3.2 支付幂等
  - N4 可用性
    - N4.1 字段级校验与提示
    - N4.2 关键操作确认（删除、支付）
  - N5 兼容与维护
    - N5.1 主流浏览器兼容
    - N5.2 模块化接口、错误码规范

### 3.3 数据需求树（D）

- D 数据总览
  - D1 表结构
    - D1.1 users（username 唯一、id_number 唯一）
    - D1.2 passengers（user_id、id_number 唯一、discount_type）
    - D1.3 trains（train_no、train_type、站点时刻、travel_date、席别与价格映射）
    - D1.4 orders（user_id、train_id、status、金额、时间戳）
    - D1.5 order_items（order_id、passenger_id、seat_class、price）
  - D2 约束与索引
    - D2.1 唯一键与组合唯一（`trains(train_no, travel_date)`）
    - D2.2 常用查询字段索引
  - D3 初始化数据
    - D3.1 2025-12-15（G101/D313/K511/G7001/D5401/G7002）
    - D3.2 2025-12-16（G103/D315/G153/G7003）
  - D4 映射与特殊值
    - D4.1 城市-车站映射（北京/南京/上海）
    - D4.2 到达跨日表示（如 `14:45+1`）

## 4. 测试用例到场景映射（追踪）

- test1-1 注册 → S1 用户注册与登录（注册部分）
- test1-2 登录 → S1 用户注册与登录（登录部分）
- test2-1 查看乘车人 → S2 常用乘车人管理（查看）
- test2-2 添加乘车人 → S2 常用乘车人管理（新增）
- test2-3 删除乘车人 → S2 常用乘车人管理（删除）
- test3-1 查询车票 → S3 车票查询（单程）
- test3-2 筛选车次类型 → S4 车次筛选（类型）
- test3-3 筛选席别 → S4 车次筛选（席别）
- test3-4 修改查询条件 → S4 条件修改与刷新
- test4-1 选择车次 → S5 订单创建（预订）
- test4-2 提交订单 → S5 订单创建（提交）
- test4-3 支付订单 → S6 订单支付（模拟）与列表查看
- test5-1 查看个人信息 → S7 个人信息查看
- test5-2 修改个人信息 → S7 联系方式编辑

## 5. 场景验收清单（摘要）

- S1：注册成功跳转首页；登录后显示“您好, New User”
- S2：列表显示默认乘客；新增“张三”“李四”；删除“张三”后列表无该项
- S3：北京→上海（2025-12-15）结果展示
- S4：类型仅 D 显示动车；席别仅“一等座”过滤；南京→上海条件刷新
- S5：预订进入订单页；勾选“New User”，席别“二等座”；生成“待支付”
- S6：“去支付”后提示成功；状态改“已支付”；“未出行订单”可见
- S7：个人信息可见；邮箱保存后提示“修改成功”且显示更新值

## 需求完成情况

### 功能需求树（F）
**完成度概览**
- F1 用户认证
  - 完成 F1.1 注册（表单校验、协议勾选、默认乘客创建）
    - 前端字段校验与提示：`frontend/src/components/Register.tsx`
    - 后端注册校验：`backend/src/utils/validation.js:110-155`
    - 默认乘客注入（个人中心加载时若缺失本人则注入）：`frontend/src/pages/ProfilePage.tsx:77-92`
  - 完成 F1.2 登录（账号密码、成功问候语展示、会话）
    - 登录与会话 JWT：`backend/src/utils/auth.js:23-37`、`frontend/src/services/api.ts:13-23`
    - 登录后问候语展示（个人中心首页）：`frontend/src/pages/ProfilePage.tsx:698-703`

- F2 常用乘车人
  - 完成 F2.1 查看（列表展示）：`frontend/src/pages/ProfilePage.tsx:848-973`
  - 完成 F2.2 添加（姓名/证件/手机号/优惠类型校验与保存）
    - 前端校验（中文姓名、18位身份证、手机号）：`frontend/src/components/AddPassengerModal.tsx:42-61`
    - 后端校验与保存：`backend/src/utils/validation.js:157-184`、`backend/src/controllers/passengerController.js:31-89`
  - 完成 F2.3 删除（确认框、受限删除策略）
    - 删除确认与“默认乘车人不可删除”：`frontend/src/pages/ProfilePage.tsx:368-383`

- F3 车票查询与筛选
  - 完成 F3.1 单程查询（城市、日期）
    - 首页查询跳到结果页：`frontend/src/pages/HomePage.tsx:34-43`
    - 城市→多车站查询展开（结果页首次加载自动展开）：`frontend/src/pages/TrainListPage.tsx:118-146`
    - 后端多站查询：`backend/src/controllers/trainController.js` 中 `Op.in`（已实现，前端 `searchTrains` 支持数组：`frontend/src/services/trainService.ts:61-76,70-76`）
  - 完成 F3.2 按车次类型筛选（G/D/K 等）
    - 类型筛选：`frontend/src/pages/TrainListPage.tsx:158-172`
  - 完成 F3.3 按席别筛选（商务/一等/二等/硬座/硬卧/软卧）
    - 席别筛选：`frontend/src/pages/TrainListPage.tsx:186-207`
  - 完成 F3.4 修改查询条件（并刷新列表）
    - 条件变更后刷新并更新 URL：`frontend/src/pages/TrainListPage.tsx:212-221`、日期联动：`frontend/src/pages/TrainListPage.tsx:271-277`

- F4 订单
  - 完成 F4.1 选择车次并预订（跳转订单页）
    - 从车次列表进入订单页：`frontend/src/pages/TrainListPage.tsx:238-255`
  - 完成 F4.2 提交订单（乘客勾选、席别选择、待支付）
    - 乘客选择与席别选择：`frontend/src/pages/OrderPage.tsx:700-777,753-763`
    - 提交并进入核对/处理流程：`frontend/src/pages/OrderPage.tsx:361-419,421-436`
    - 订单创建与座位事务预留：`backend/src/controllers/orderController.js:47-106,107-167`
  - 完成 F4.3 支付订单（模拟支付、状态更新）
    - 支付弹窗与成功回调：`frontend/src/components/PaymentModal.tsx:25-64,82-90`
    - 状态更新为已支付：`frontend/src/pages/OrderPage.tsx:509-535` → 后端状态更新：`backend/src/controllers/orderController.js:486-546`
  - 完成 F4.4 订单列表（未完成/未出行）
    - 个人中心订单列表与筛选：`frontend/src/pages/ProfilePage.tsx:988-1099,990-1005`
    - 列表拉取接口：`frontend/src/services/orderService.ts:79-96`、后端：`backend/src/controllers/orderController.js:301-344`
    - 支付或取消后跳转订单中心并显示最新状态：`frontend/src/pages/OrderPage.tsx:524-533,537-543` 和 `frontend/src/pages/ProfilePage.tsx:280-283`

- F5 个人信息
  - 完成 F5.1 查看个人信息（基本信息与联系方式）：`frontend/src/pages/ProfilePage.tsx:729-833`
  - 完成 F5.2 编辑联系方式（邮箱编辑与保存）
    - 编辑并调用后端更新：`frontend/src/pages/ProfilePage.tsx:776-801,231-246`

- F6 初始化与数据
  - 部分完成 F6.1 用户状态清理（`new user`）
    - 用户名规则放宽（允许空格），并在乘车人加载时保证“本人”默认项：`backend/src/utils/validation.js:11-13`、`frontend/src/pages/ProfilePage.tsx:77-92`
  - 部分完成 F6.2 车次数据预置（2025-12-15/16 全量）
    - 有数据预置与座位余票逻辑（确认页与列表可查询到 2025 年车次）；种子入口：`backend/src/app.js:6` 引入 `seedData`（具体种子细节未统一展示）


### 非功能需求树（N）
**完成情况概览**
- N1.1 密码散列存储 完成
  - 使用 `bcryptjs`，盐轮次 12，封装散列与校验函数
  - 位置：`backend/src/utils/auth.js:4-21`
- N1.3 访问控制 完成
  - 订单、乘客等路由统一使用认证中间件
  - 位置：`backend/src/routes/order.js:13-27`、`backend/src/routes/passenger.js:1-23`
- N4.1 字段级校验与提示 完成
  - 后端对用户名、身份证、手机号、邮箱、注册表单、乘车人数据校验
  - 位置：`backend/src/utils/validation.js:1-195`
  - 前端注册/添加乘车人组件同步做校验（如身份证、手机号）
  - 位置：`frontend/src/components/Register.tsx`、`frontend/src/components/AddPassengerModal.tsx`
- N4.2 关键操作确认 完成
  - 退出登录、退票、删除乘车人、提交订单等交互均有确认或提示
  - 位置：`frontend/src/pages/ProfilePage.tsx:146-152`、`frontend/src/pages/ProfilePage.tsx:437-466`、`frontend/src/pages/ProfilePage.tsx:374-383`、`frontend/src/pages/OrderPage.tsx:361-406`
- N3.1 订单事务保障 完成
  - 创建订单与座位预留在事务中进行，出现错误回滚；取消订单时释放座位同样在事务中
  - 位置：`backend/src/controllers/orderController.js:6-217`、`backend/src/controllers/orderController.js:384-483`
- N5.1 主流浏览器兼容 完成
  - 纯 React + 标准 CSS，未使用不兼容的 API；提供响应式断点与降级 UI
  - 位置：前端各 `*.css` 文件（如 `frontend/src/pages/HomePage.css`、`frontend/src/components/OrderConfirmModal.css`）
- N5.2 模块化接口、错误信息规范 部分完成
  - 接口模块化（auth/order/train/passenger），统一返回 `success/message/data`；但没有统一错误码枚举，部分地方仍是 `console.error`
  - 位置：`backend/src/app.js:23-33` 路由聚合；各 `controllers/*` 返回结构统一

**部分完成或待完善**
- N1.2 会话安全 部分完成
  - 使用 JWT，前端 `Authorization: Bearer` 方式；未使用 HttpOnly Cookie，因此浏览器层的 CSRF 防护、HttpOnly/Secure 属性不具备
  - 位置：`backend/src/utils/auth.js:23-37`、`frontend/src/services/api.ts:13-23`
- N1.4 操作日志 部分完成
  - 关键流程有 `console.log`（认证、订单取消与创建），但未落地到持久化日志或统一日志中间件
  - 位置：`backend/src/utils/auth.js:59-86`、`backend/src/controllers/orderController.js:392-419`
- N2.1 查询响应 ≤ 2s、N2.2 UI 反馈 ≤ 1s 部分完成
  - 列表与筛选有 loading 态与即时筛选（如车次查询、订单列表），但没有指标监控或 SLA 统计；查询依赖 SQLite/Sequelize，数据量大时未经优化
  - 位置：`frontend/src/pages/TrainListPage.tsx:368-397`、`frontend/src/pages/ProfilePage.tsx:988-1099`
- N3.2 支付幂等 部分完成
  - 支付完成后只允许合法状态更新；但没有显式的幂等键/回调签名校验，重复请求的保障力度有限
  - 位置：`backend/src/controllers/orderController.js:486-546`（状态校验与更新）

**说明与建议**
- 会话安全建议
  - 后端增加 Cookie 模式（HttpOnly/Secure/SameSite=Lax），配合 CSRF Token（双提交/加密 Token）
  - 对输入做统一的 XSS 过滤与输出转义（目前主要依靠 React 默认安全）
- 操作日志建议
  - 引入统一日志库（如 `winston`），落地到文件/数据库；为注册/登录/乘客增删/订单创建与支付增加结构化日志
- 性能与可靠性建议
  - 为查询接口加缓存层/索引优化，增加 Prometheus 指标与响应时间统计
  - 为支付接口设计幂等键（如 `client_request_id`）与重复请求检测，保障“至多一次”或“恰好一次”

### 数据需求

**完成度概览**
- D1 表结构
  - 完成 D1.1 `users`（唯一约束）
    - 字段与唯一：`username`、`id_number`、`phone_number` 唯一索引，长度与格式校验
    - 位置：backend/src/models/User.js:10-17,40-46,54-61,92-108
  - 完成 D1.2 `passengers`（外键与唯一性校验）
    - 外键 `user_id` → `users.id`；业务层校验同一用户下 `id_number` 不重复
    - 模型索引：`user_id`、`user_id,is_default`、`id_number`
    - 位置：backend/src/models/Passenger.js:10-18,82-92
    - 业务唯一校验：backend/src/controllers/passengerController.js:27-61
  - 完成 D1.3 `trains`（车次基础信息）+ `train_seats`（席别与价格映射）
    - `trains`：`trainNumber/trainType/stations/time/duration`
      - 位置：backend/src/models/Train.js:10-20,21-45
    - `train_seats`：按天的 `seatType/price/availableSeats`
      - 位置：backend/src/models/TrainSeat.js:10-28,29-43
  - 完成 D1.4 `orders`（用户、车次、状态、金额、时间戳）
    - 字段：`user_id/train_number/stations/departure_date/time/total_price/status/payment_*`
    - 位置：backend/src/models/Order.js:10-16,17-26,27-67,68-90,91-102
  - 完成 D1.5 `order_items`（对应 `order_passengers`）
    - 字段：`order_id/passenger_name/id_card/seat_type/ticket_type/price`
    - 位置：backend/src/models/OrderPassenger.js:10-19,20-65

- D2 约束与索引
  - 部分完成 D2.1 组合唯一（`trains(train_no, travel_date)`）
    - 当前实现为 `train_seats(train_number,date,seat_type)` 组合唯一（更细化到席别）
    - 位置：backend/src/models/TrainSeat.js:55-67
    - `trains` 仅对 `trainNumber` 唯一：backend/src/models/Train.js:10-15
  - 完成 D2.2 常用查询字段索引
    - `users`：`username/id_number/phone_number/email` 索引 backend/src/models/User.js:92-108
    - `orders`：`user_id/order_id/status/departure_date` 索引 backend/src/models/Order.js:106-119
    - `order_passengers`：`order_id/id_card` 索引 backend/src/models/OrderPassenger.js:79-88
    - `passengers`：`user_id/user_id,is_default/id_number` 索引 backend/src/models/Passenger.js:82-91
    - `train_seats`：`train_number,date/seat_type` 索引 backend/src/models/TrainSeat.js:57-67

- D3 初始化数据
  - 完成 D3.1 2025-12-15（G101/D313/K511/G7001/D5401/G7002）
  - 完成 D3.2 2025-12-16（G103/D315/G153/G7003）
    - 车次初始化：backend/src/scripts/seedData.js:166-276
    - 指定日期座位初始化：backend/src/scripts/seedData.js:347-366
    - 按列车类型的默认 30 天座位生成：backend/src/scripts/seedData.js:301-345

- D4 映射与特殊值
  - 完成 D4.1 城市-车站映射（北京/南京/上海 等）
    - 城市到车站映射与解析：frontend/src/utils/cityStationMap.ts:12-19,32-44,97-117
    - 查询页首次加载自动展开城市为车站数组：frontend/src/pages/TrainListPage.tsx:118-146
  - 完成 D4.2 到达跨日表示（如 `14:45+1`）
    - 示例车次 `K511` 到达时间带 `+1`：backend/src/scripts/seedData.js:190-199

**说明**
- 我们把“每日座位与价格映射”放在 `train_seats`，因此组合唯一约束是 `(train_number, date, seat_type)`，比需求中的 `(train_no, travel_date)` 更精确，满足按席别查询与余票更新。
- 初始化数据覆盖了需求中的两天指定车次，并且还为未来 30 天自动生成座位数据，便于测试。
- 城市-车站映射已用于首页与车票查询页的城市级搜索，查询会自动展开为多站检索，保障数据覆盖与查询体验。

---



