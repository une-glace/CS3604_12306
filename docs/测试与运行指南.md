# 项目测试与运行指南

## 测试类型概览
- 后端集成测试（Jest, SQLite）：覆盖认证、订单、座位、车次、校验等逻辑。
- 后端 MySQL 测试（Jest, MySQL）：验证与 MySQL 架构的兼容性（枚举、长度、迁移）。
- 前端端到端测试（Playwright）：覆盖登录、乘车人管理、订票与支付、订单中心、筛选与车次列表等。
- 前端单元测试（Vitest）：对前端模块进行轻量校验。
- 前端质量检查：Lint 与 Typecheck。

## 目录结构
- 后端测试目录：`backend/tests/`
  - 主要用例：`auth.spec.js`、`order.spec.js`、`seats.spec.js`、`train.spec.js`、`validation.spec.js` 等
- 前端 E2E 目录：`frontend/tests/e2e/`
  - 主要用例：`auth.spec.ts`、`passengers.spec.ts`、`passenger-view.spec.ts`、`order.spec.ts`、`orders-pay.spec.ts`、`orders-center.spec.ts`、`filters.spec.ts`、`trains.spec.ts`、`book-from-list.spec.ts`
  - 辅助工具：`frontend/tests/e2e/utils/auth.ts`（统一登录与兜底逻辑，确保稳定进入个人中心）

## 环境要求
- Node.js `20`
- 前后端依赖：`npm ci --prefix backend`、`npm ci --prefix frontend`
- 浏览器依赖（E2E）：`npx playwright install --with-deps`（Linux CI 环境需要）
- 本地数据库：默认用 SQLite；MySQL 测试需要本地 MySQL 或容器服务

## 后端测试
**SQLite 集成测试**
- 安装依赖：`npm ci --prefix backend`
- 运行：`npm test --prefix backend`
- 可选覆盖率：`npm test --prefix backend -- --coverage`
- 相关配置文件：`backend/src/config/database.js`
  - 在非 MySQL 下启用 WAL 与 `busy_timeout`，提升并发稳定性（`backend/src/config/database.js:33-38`）

**MySQL 测试**
- 安装依赖：`npm ci --prefix backend`
- 启动 MySQL（示例）
  - Docker：`docker run -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=trae_12306 -p 3306:3306 mysql:8`
- 运行：`npm run test:mysql --prefix backend`
  - 测试脚本位置：`backend/src/scripts/testMysql.js`（会在 Jest 前执行迁移）
  - 迁移内容：
    - 将 `users.passenger_type` 调整为 `ENUM('成人','儿童')` 并将旧值 `'1'/'2'` 映射为中文枚举（`backend/src/scripts/testMysql.js:24-48`）
    - 将 `order_passengers.phone` 长度调整为 `VARCHAR(15)`（`backend/src/scripts/testMysql.js:49-61`）
  - Sequelize 同步策略：MySQL 非 `force` 启用 `{ alter: true }`（`backend/src/models/index.js:80`）

## 前端 E2E 测试
**准备**
- 安装依赖：`npm ci --prefix backend && npm ci --prefix frontend`
- 安装浏览器：`npx playwright install`
- 启动服务：
  - 后端：`npm start --prefix backend`
  - 前端：`npm run dev --prefix frontend -- --open false`
- 等待就绪（可选）：`npx -y wait-on http://localhost:3000/health http://localhost:5174`

**运行 E2E**
- 运行全部：`npm run test:e2e --prefix frontend`
- 运行单文件：`npm run test:e2e --prefix frontend -- tests/e2e/passengers.spec.ts`
- 指定报告：`npm run test:e2e --prefix frontend -- --reporter=line`

**关键辅助：统一登录**
- 入口函数：`frontend/tests/e2e/utils/auth.ts:3`
- 逻辑要点：
  - 尝试 UI 登录并处理弹窗竞态；失败则调用后端 API 登录（必要时注册链路），写入 `localStorage` 并跳转个人中心
  - 成功后等待 `.profile-page` 可见，避免未登录或中途跳转导致断言失败

## 前端单元测试
- 运行：`npm run test:unit --prefix frontend -- --coverage`
- 依赖：Vitest，按前端模块的单测覆盖情况输出报告

## 前端质量检查
- Lint：`npm run lint --prefix frontend`
- Typecheck：`npm run typecheck --prefix frontend`
- 注意：项目中有若干非阻塞的 `any` 与 `prefer-const`、hooks 依赖等提示，不影响当前 E2E 与集成测试通过

## 常见问题与排查
- E2E 登录不稳定：确保使用 `ensureLogin(page)`，避免在每个用例手写 UI 登录逻辑引入竞态
- E2E 报 sqlite 并发写锁：确认已启用 WAL 与 `busy_timeout`（`backend/src/config/database.js:33-38`）
- MySQL 测试枚举/长度错误：
  - 注册时 `passenger_type` 映射为中文枚举（`backend/src/controllers/authController.js:99-108`）
  - 默认乘车人枚举兼容（`backend/src/controllers/passengerController.js:16-23`）
  - 订单乘客手机号长度为 15，入库前校验超长返回 400（`backend/src/models/OrderPassenger.js:33-36`、`backend/src/controllers/orderController.js:173-183`）

## 在 CI 中如何运行
- 触发：对任意分支的 `push` 或 `pull_request`（`\.github/workflows/ci.yml:3-9`）。
- 作业：
  - `backend-tests`（SQLite）：`npm test -- --coverage`（`ci.yml:37-41`）
  - `e2e-tests`（前端 E2E 与单测）：在启动后端与前端服务后运行 E2E（`ci.yml:79-103`）
  - `backend-tests-mysql`（MySQL）：使用服务容器并运行 `npm run test:mysql`（`ci.yml:142-178`）
- 并发取消：同一分支的最新提交会取消旧运行（`ci.yml:11-13`）

## 示例：本地一次性验证
- 安装依赖：`npm ci --prefix backend && npm ci --prefix frontend`
- 启动服务：
  - `npm start --prefix backend`
  - `npm run dev --prefix frontend -- --open false`
- 运行 E2E：`npm run test:e2e --prefix frontend -- --reporter=line`
- 运行后端测试：`npm test --prefix backend`
- 运行 MySQL 测试（需 MySQL）：`npm run test:mysql --prefix backend`
- 运行前端单测：`npm run test:unit --prefix frontend -- --coverage`
- 质量检查：`npm run lint --prefix frontend && npm run typecheck --prefix frontend`