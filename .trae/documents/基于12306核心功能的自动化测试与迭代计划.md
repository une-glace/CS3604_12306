## 测试策略

* 端到端测试：在 `frontend` 使用 Playwright 编写 UI 自动化，覆盖注册/登录、乘车人、车票查询与筛选、订票与支付、个人信息。

* 后端接口测试：在 `backend` 使用 `jest + supertest` 覆盖认证、乘车人、订单、车次查询与座位变更。

* 数据准备：复用后端现有 `seedData`，按测试文档写入指定日期与车次数据；确保座位与价格与测试一致。

* 失败驱动迭代：按测试运行结果修正代码（CORS、真实查询替换 mock、关键元素 `data-testid`、路由一致性）。

## 目录与运行

* 前端：`d:\软件工程与项目管理\12306-replica\frontend` 启动 `npm run dev`，端口 `5174`。

* 后端：`d:\软件工程与项目管理\12306-replica\backend` 启动 `npm run dev` 或 `npm start`，端口 `3000`，基础路径 `/api/v1`。

* 代理：前端 `/api` 指向后端 `http://localhost:3000`。

## 选择器与定位策略

* 注册（`frontend/src/components/Register.tsx`）

  * 用户名 `input#username` (341)、密码 `input#password` (361)、确认密码 `input#confirmPassword` (379)、姓名 `input#realName` (417)、证件号 `input#idNumber` (438)、手机号 `input#phoneNumber` (495)、协议 `input[name="agreementAccepted"]` (517)、下一步 `button.next-btn` (586)、完成注册 `button.submit-btn` (594)

* 登录（`frontend/src/components/Login.tsx`）

  * `input#username` (177)、`input#password` (190)、提交 `button.login-button` (206)

* 乘车人（`frontend/src/components/AddPassengerModal.tsx`、`frontend/src/pages/ProfilePage.tsx`）

  * 姓名 `input#name` (96)、证件 `input#idCard` (122)、电话 `input#phone` (136)、提交 `button.submit-btn` (153)、添加按钮 `button.add-action` (Profile 800)、删除 `button.op-btn.delete` (Profile 874)

* 车票查询与筛选（`frontend/src/components/SearchConditions.tsx`、`frontend/src/components/FilterConditions.tsx`、`frontend/src/components/TrainList.tsx`）

  * 出发地/目的地 `input.station-input` (154/172)、出发日期 `input#departure-date` (187)、查询按钮 `button.search-button` (237)、类型复选 `label.line-option > input[type="checkbox"]` (123)、席别复选同 (239)、预订 `button.book-button.available` (TrainList 255)

* 订单提交与支付（`frontend/src/pages/OrderPage.tsx`、`frontend/src/components/OrderConfirmModal.tsx`、`frontend/src/components/PaymentModal.tsx`）

  * 提交 `button.btn-submit` (OrderPage 689)、确认 `button.confirm-btn` (185)、选座 `button.seat-opt` (142)、支付二维码 `img.qr-code` (141)

## 端到端测试用例（Playwright）

* 用户认证

  * 注册：按测试文档 `test1-1` 流程填写与提交；断言提示和首页跳转以及顶部问候。

  * 登录：按 `test1-2` 填写与提交；断言首页显示“您好, New User”。

* 常用乘车人管理

  * 查看乘车人：进入个人中心 → “乘车人”列表；断言默认乘客存在。

  * 添加乘车人：新增两名（张三/李四），断言列表出现；删除张三并确认移除。

* 车票查询与筛选

  * 查询：单程，北京→上海，日期 `2025-12-15`，断言列表有匹配车次。

  * 筛选：车次类型仅勾选 D；席别仅勾选“一等座”；断言刷新后列表符合条件。

  * 修改查询：南京→上海，点击查询并断言列表更新。

* 订票与订单管理

  * 选择车次：在列表点击第一个“预订”进入订单页，断言列车与乘客模块渲染。

  * 提交订单：勾选 `New User`、选“二等座”，提交并确认，断言订单详情“待支付”。

  * 支付订单：进入订单中心“未完成订单”，点击“去支付”并确认支付成功提示；返回列表断言状态为“已支付”，在“未出行订单”出现。

* 个人信息管理

  * 查看：个人中心“查看个人信息”，断言基本信息与联系方式展示。

  * 修改邮箱：触发编辑，填 `newuser@example.com`，保存并断言“修改成功”和显示更新。

## 后端接口测试用例（jest + supertest）

* 认证：`/auth/register`、`/auth/login`、`/auth/me`，断言 JWT 返回与权限拦截生效。

* 乘车人：`/passengers` CRUD，断言数据校验和关联用户隔离。

* 车次：`/trains/search`、`/trains/:trainNumber?date=...`，断言搜索过滤和座位价格/余票返回。

* 订单：创建、状态更新（待支付→已支付）、取消释放座位，断言 `TrainSeat.availableSeats` 变更。

## 数据准备与种子

* 使用 `backend/src/scripts/seedData.js`：扩展添加测试文档列车

  * 2025-12-15：G101、D313、K511、G7001、D5401、G7002

  * 2025-12-16：G103、D315、G153、G7003

* 每个车次按席别写入 `TrainSeat`：包含“二等/一等/商务/硬座/硬卧/软卧”等，价格与测试一致，`availableSeats` 为合理正数。

## 代码调整建议（按测试反馈推进）

* CORS：将后端允许源更新为 `http://localhost:5174`，避免跨域失败。

* 真实查询替换：`frontend/src/pages/TrainListPage.tsx` 将 `mockTrains` 改为调用 `/trains/search`；保证筛选一致性（前端条件映射到后端查询参数）。

* 稳定选择器：为关键按钮与输入补充 `data-testid`，避免 UI 文本变动导致不稳定。

* 路由一致性：统一使用 `react-router-dom` 的 `Link`/`navigate`，避免整页刷新影响测试。

## 执行与验收

* 步骤

  * 初始化后端数据库并运行种子脚本。

  * 启动后端与前端服务。

  * 运行后端接口测试；修正接口问题。

  * 运行前端 Playwright E2E；根据失败逐项修复（CORS、真实查询、选择器、路由）。

* 验收标准

  * 所有 E2E 用例通过，UI 行为与测试文档期望一致。

  * 接口测试全部通过；订单与座位变更正确。

  * 手动抽检首页与车次列表交互流畅，无整页刷新与跨域报错。

## 需要确认

* 是否接受将“车次搜索”改为真实后端查询（替换当前前端 mock），以保证测试覆盖真实数据与接口。

* 是否允许在关键元素上增加 `data-testid` 提升选择器稳定性。

