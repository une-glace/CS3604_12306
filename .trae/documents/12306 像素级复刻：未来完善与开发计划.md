# 项目未来完善与开发路线图

## 当前能力概览
- 前端：React 19 + Vite 7 + TypeScript，Playwright 端到端测试，基础路由与页面已具备（frontend/package.json:1-33，frontend/tests/e2e/*）。
- 后端：Express 5 + Sequelize（SQLite 开发库），JWT 鉴权与基础业务（用户/乘车人/车次/订单）已完成（backend/src/app.js:28-33，backend/src/routes/*，backend/src/controllers/*）。
- 测试：后端 jest + supertest；前端 Playwright E2E；已有种子数据脚本（backend/tests/*，frontend/tests/e2e/*，backend/src/scripts/seedData.js）。
- 配置：API 前缀与 CORS 已设置；前端直连后端（frontend/src/services/api.ts:1，backend/src/app.js:29-33, 20-23）。

## 近期（1–2 迭代）：功能完善与体验优化
- 车票与筛选一致性完善
  - 将热门路线与站点数据改为真实数据源或静态表，提供模糊匹配与拼音/缩写搜索，比如输入“北”跳出“北京”选项
- 订单全流程补齐
  - 增加“改签/退票”接口与状态机，明确允许的状态跃迁与退款规则。
  - 支持“座位偏好 + 连坐”在 UI 与后端分配算法中的贯穿。
- 用户与乘车人
  - 乘车人校验规则强化（证件/手机号/类型），默认乘车人编辑范围与保护策略明确。
  - 个人信息页补充更多字段与校验、邮箱验证流程与提示。
- UI/UX 与可用性
  - 首页与轮播、检索表单的响应式与性能优化；为关键交互增加 data-testid 稳定选择器。

## 中期（2–4 迭代）：数据、并发与可靠性
- 库迁移与建模
  - 从 SQLite 迁移至 MySQL，完善连接池、索引与约束，输出迁移脚本与回滚方案（backend/src/config/database.js:4-20；backend/package.json:29-33 存在 mysql2 依赖）。
  - 规范订单/座位模型：为余票更新与历史追踪设计审计字段与幂等键（orderId/seatType/date/trainNumber）。
- 余票控制与并发安全
  - 以事务/乐观锁/分布式锁确保“减票不为负、并发一致”：
    - 数据层：增加 version 字段或使用 SELECT … FOR UPDATE；失败重试策略。
    - 缓存层：引入 Redis 进行席别余票缓存与热点 Key 限流（backend/package.json:30-33 存在 redis 依赖）。
    - 队列层：高峰期下单队列与有界重试，保证峰值可控与用户反馈及时。
- 支付模拟升级
  - 引入支付状态机与回调（webhook）模拟，明确幂等与签名校验；支付记录与账务核对。
- 可靠性与观测性
  - 统一日志（请求/业务/错误）与结构化输出；增加健康探针、就绪探针与基础指标（QPS/错误率/接口耗时）（backend/src/app.js:45-51）。
  - 异常告警与重试：针对座位更新/订单状态更新的失败路径增加补偿任务。
- 测试体系扩展
  - 增加契约测试（前后端接口契约）、并发与性能测试（压力/稳态/毛刺），覆盖余票与状态机边界。
  - E2E 场景扩展：改签/退票/连坐/多站点查询与筛选组合用例。

## 远期（5+ 迭代）：架构演进与生态
- 服务化与扩展性
  - 领域拆分：Auth/Passenger/Train/Order 四域服务与 API 网关；公共库抽取（校验/鉴权/日志）。
  - 消息总线与事件溯源：订单创建/支付/取消事件驱动下游（席别释放、通知、风控）。
- 风控与安全
  - 登陆保护（验证码、设备指纹、风控评分与冻结）、接口限流与黑白名单；JWT 轮换与短 Token + 刷新令牌设计（backend/src/utils/auth.js:24-33, 55-86）。
  - 敏感信息保护与合规（脱敏/审计/合规留痕）。
- 搜索与数据
  - 车站/车次数据维护管线：从权威源定期拉取，增量更新与校验；历史价格与余票分析。
  - 推荐与智能：热门路线与高峰预测、价格/席别推荐。
- 端体验
  - PWA 与移动端适配；离线缓存与弱网优化；可访问性（A11y）与国际化。
- 性能与交付
  - SSR/预渲染与关键首屏优化；资源切片与长缓存策略；灰度/蓝绿发布与回滚。

## 关键改造点与代码参考
- 路由与 API 前缀：backend/src/app.js:29-33
- 健康检查：backend/src/app.js:45-51
- 订单状态更新与取消：backend/src/routes/order.js:26-29；backend/src/controllers/orderController.js:485-546, 384-483
- 座位余票更新与分配：backend/src/controllers/orderController.js:75-105, 219-299
- 车次搜索与席别返回：backend/src/controllers/trainController.js:5-118
- 站点/热门路线（可替换数据源）：backend/src/controllers/trainController.js:182-266
- 鉴权与中间件：backend/src/utils/auth.js:55-86；frontend/src/services/api.ts:14-23
- 前端接口与基址：frontend/src/services/api.ts:1；车次搜索：frontend/src/services/trainService.ts:46-84
- 测试位置：frontend/tests/e2e/*，backend/tests/*

## 里程碑与交付物
- M1（第1迭代）：筛选一致性、订单状态机雏形、UI 响应式与选择器稳定化；E2E 通过基础用例。
- M2（第2迭代）：MySQL 迁移与数据脚本、Redis 缓存与并发保护、支付模拟与幂等；契约测试落地。
- M3（第3迭代）：观测性（日志/指标/告警）、队列化下单与失败补偿；压测报告与优化清单。
- M4（第4迭代）：服务化拆分 PoC、风控与限流、PWA 及移动端适配；灰度发布流程。
- M5（第5迭代+）：数据管线与推荐、SSR/预渲染、国际化与可访问性；长期维护与版本策略。

## 风险与应对
- 数据一致性与并发：以“数据库事务 + Redis 锁 + 队列”三层保障；设计幂等键与重试策略。
- 支付与合规：即便模拟亦需签名/回调与审计；上线前进行安全评估与演练。
- 迁移与切换风险：提供灰度/双写/回滚与备份策略；在低峰时窗口执行。

## 成功标准
- 功能：核心流程（注册/登录/查询/下单/支付/改签/退票）可用且边界覆盖充分。
- 质量：E2E 与接口测试全面通过；压测下余票一致，错误率与 P95 延迟达标。
- 体验：首屏性能优、移动端适配良好；交互稳定与可测性强（选择器与路由一致）。
